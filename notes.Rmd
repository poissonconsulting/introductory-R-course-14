---
title: "Introductory R Course"
author: "Joe Thorley"
date: "August 6, 2014"
output:
  pdf_document:
    number_sections: yes
    toc: yes
  html_document:
    toc: yes
bibliography: references.bib
---

```{r,echo = FALSE}

library(knitr)

exercise_number <- 0
exercise <- function (txt) {
  exercise_number <<- exercise_number + 1
  cat(paste0("\n**Exercise** ", exercise_number), paste0("*", txt, "*\n"))
}

ktable <- function (...) {
  x <- c(...)
  mat <- matrix(NA, nrow = length(x), ncol = 2)
  mat[, 1] <- names(x)
  mat[, 2] <- x
  colnames(mat) <- mat[1,]
  mat <- mat[-1, , drop = FALSE]
  mat <- mat[order(mat[, 1, drop = TRUE]), , drop = FALSE]
  cat("\n")
  cat(kable(mat, row.names = FALSE, output = FALSE), sep = "\n")
  cat("\n")
}

```

# Introduction

The purpose of these course notes is to introduce participants to basic programming, graphics and statistics in R [@r_core_team_r:_2013] [@bradford_using_2005 pp. 23-34, and some]
[-@royle_hierarchical_2008]. see @royle_hierarchical_2008 [pp. 33-45]

## R, S and S-Plus

R and S-PLUS are both implementations for the S language which is a language for 'programming with data'. R is free and open source. 

## Installation

Download the the most recent version of the base distribution binary for your platform from http://cran.r-project.org/ and install using the default options. Then start up R.

# R Basics

## Calculations
R can be used just like a calculator. An expression is entered at the `>` prompt and the result printed.
```{r}
3 + 4
3 * 4
```

To faciliate cut and paste the R code in this document is not preceded by the `>` prompt and any output is preceded by two comment characters `##` (comments are introduced below).

The `[1]` at the start of each result indicates that the result is the first element in a *vector* (vectors are introduced below).

```{r, echo = FALSE, results = 'asis'}
exercise("What is nine raised to the power of three?")
exercise("And nine raised to the power of 0.5?")
exercise("97 out of 284 eggs survive. What is the mortality expressed as a percentage?")
exercise("What is the result of `3 * 4 + 5`? And `5 + 3 * 4`? What does this indicate?")
```

## Precedence
In R, if one operator has *precedence* over another then it is evaluated first. The order in which operators are evaluated can be controlled using brackets.
```{r}
3 * 4 + 5
3 * (4 + 5)
```

```{r, echo = FALSE, results = 'asis'}
exercise("Does the `*` operator have precedence over the `^` operator? 
Demonstrate with an example.")
```

## Functions
Most of R's functionality comes from its *functions*. A function takes zero, one or multiple *arguments*, depending on the function and returns a value. To call a function enter it's name followed by brackets - include any arguments in the brackets.
```{r}
log(10)
```

To find out more about a function `fun` type `?fun`. To search for the functions associated with a topic type `??topic` or `??"multiple topics"`.

```{r, echo = FALSE, results = 'asis'}
exercise("Which function calculates cumulative sums? And what arguments does it take?")
```

## Arguments
The R Documentation for `log` indicates that the function requires an argument `x` that is a vector of
*numeric* (real) or *complex* numbers and an argument `base` which is the base of the logarithm. 
If undefined the value of `base` is set to be `exp(1)`, i.e., `log` calculates natural logarithms by default.

When calling a function its arguments can be specified using *positional* and/or 
*named* matching.

```{r}
log(x = 10, base = 2)
log(base = 2, x = 10)
log(10, 2)
log(2, 10)
```

```{r, echo = FALSE, results = 'asis'}
exercise("What arguments does the function `sqrt` take?")
```

## Assignment
The result of an expression can be *assigned* to an object using the `<-` operator. The object can then be used in subsequent expressions. To save finger strokes type alt-.
```{r}
x <- 3 + 4
x
x / 2
y <- x * x
y
```


```{r, echo = FALSE, results = 'asis'}
exercise("Set `x` to be `7`. What is the value of `x^x`. Save the value in a object called `i`. If you assign the value `20` to the object `x` does the value of `i` change? What does this indicate about how R assigns values to objects?")
```

## Workspace
When a value is assigned to an object, the object can be used in subsequent calculations because it is stored in the *workspace*. The workspace is an area of memory associated with the current session.

The `ls()` function lists the objects in the workspace. Calling `rm(x)` deletes object `x` from the workspace. Typing `rm(list = ls())` removes all objects.

```{r, echo = FALSE, results = 'asis'}
exercise("Using the `rm` function and the assignment operator arrange your workspace so that 
it contains three objects `x`, `y` and `z` with values of `3`, `5` and `7`, respectively.")
```

## Vectors
A *vector* is a string of values.

### Generation
Vectors can be created using the `c` (concatenate) and `seq` (sequence) functions.
```{r}
c(1, 3, 5, 7, 13)
seq(from = 1, to = 11, by = 2)
seq(1, 6)
```
The `length` function returns the number of values in a vector.

```{r, echo = FALSE, results = 'asis'}
exercise("Use the `seq` function to generate a vector of `30` evenly spaced numbers from `0` to `1`. Confirm its length.")
```

## Vectorized calculations
In R, there are no scalars. Instead single values are considered vectors of length `1`. Even simple calculations are designed to be performed on vectors.
```{r}
x <- seq(3, 5)
y <- c(1, 2, 2)
x - y
x / y
```
If the vectors in an expression are of different lengths the shorter vector is *recycled*.

```{r}
x <- seq(1, 4)
y <- seq(1, 2)
x / y
```

```{r, echo = FALSE, results = 'asis'}
exercise("Create the vector that is the square root of all the whole numbers from `1` to `100`.")
exercise("Create a vector that gives the deviation of the values in the vector `seq(1, 10)` from their mean.")
```

## Classes
The vectors you have dealt with so far have been of class `numeric` which have real numbers as their permissible values.
```{r}
x <- c(1.5, 2.7)
class(x)
```

Another important vector class is `character` which has text values.
```{r}
x <- c("txt", "one", "1", "1.9")
class(x)
```

```{r, echo = FALSE, results = 'asis'}
exercise("Try combining character and numeric values together in the same vector. What happens?")
```


## Missing values
Missing values are represented by `NA`. Functions such as `min`, `max` and `mean`
that require knowledge of
all the input values return an `NA` if one or more values are missing.
This behaviour can be altered by setting the `na.rm` argument to be `TRUE`.
```{r}
x <- c(1, 2, 3, NA)
mean(x)
mean(x, na.rm = TRUE)
```

## Factors
Factors represent categorical variables.

Vectors can be coerced to class `factor` using the `as.factor` function.
```{r}
x <- c("blue", "green", "blue", "red", "green")
x <- as.factor(x)
class(x)
```

```{r, echo = FALSE, results = 'asis'}
exercise("Coerce the factor `x` to a vector of class numeric. What happens?")
```

## Data Frames
*Data frames* are the fundamental data structure in R. A data frame is a two-dimensional data set where the columns are variables (vectors) of equal length.

### data
R packages often include data sets.  To see the data sets in the current *search path}* (introducted later) type `data()`. To print a summary of the `trees` data frame type `summary(trees)`. Type `trees` to print the data frame itself. To get more information on `trees` type `?trees`.

```{r, echo = FALSE, results = 'asis'}
exercise("What are the data in the `ToothGrowth` data set?")
```

### Referencing columns
When referencing a column (vector) in a data frame both the data frame and column name must be specified.  
The `$` operator is used to separate the data frame and column name. 
```{r}
trees$Girth
```

The `$` operator can also be used to reference a new column in a data frame. In the following example the girth (circumference) is being used to estimate the cross-sectional area. 
```{r}
trees$Area <- trees$Girth^2 / (4 * pi)
summary(trees)
```

```{r, echo = FALSE, results = 'asis'}
exercise("Add a column `Diameter` to `trees` bearing in mind that `pi` is the ratio of the circumference (girth) to the diameter.")
```

# RStudio

Thus far you have been using R through its Graphical User Interface (GUI).
However a number of third-party programs provide more powerful Integrated Development Environments (IDEs) for interfacing with R. My favourite is RStudio the desktop version of which can be downloaded from http://rstudio.org/download/desktop. Like R, RStudio is free and open source. The remainder of this course is taught assuming you are using RStudio.

## Console
By default the pane in the bottom left of RStudio is the R console. You can enter expressions in the console in the same way you have been entering expressions in the R console in the R GUI.

## Workspace
The first window in the top right pane provides an interface for viewing and manipulating the objects in the workspace.

## History
The second window in the top right panel allows you to view and copy the expressions you have executed at the console.

## Packages
Everything in the S language is an object - even the functions and operators. With the exception of the workspace, all of the available objects are contained within packages.  

To see all the packages that are currently *loaded* on the *search path* type `search()`.

```{r}
search()
```
`.GlobalEnv` is the workspace. To see all the objects in a package type `ls("package:package_name")`. For example
```{r, eval = FALSE}
ls("package:stats")
```
For a detailed description of how R searches and finds objects see http://obeautifulcode.com/R/How-R-Searches-And-Finds-Stuff/.

To see all the packages that are currently installed on your computer go to the Packages window in the bottom right pane of RStudio. Packages that are currently loaded are selected. You can load a package by selecting it or by typing `library(package_name)` at the console.

```{r, echo = FALSE, results = 'asis'}
exercise("Load the package `foreign`. What arguments does the function `read.dbf` in the
`foreign` package take?")
```

To view the packages on the Comprehensive R Archive Network (CRAN) website that are currently available to install on your computer go to
http://cran.r-project.org/web/packages/available_packages_by_name.html.

You can install a package from the CRAN site onto your computer by clicking Install on the Packages window and typing its name alternatively type `install.packages("package_name")`.
```{r, echo = FALSE, results = 'asis'}
exercise("Install the package `ggplot2` onto your computer and then load it. What arguments does the function `ggplot` take.")
```

## Working Directory
Each R session is associated with a folder on your computer that is referred to as the working directory. To view the contents of the working directory go to the Files window in the bottom right pane. To change the working directory use the **Choose Directory...** suboption of the **Set Working Directory** option from the **Session** menu in the global toolbar. Alternatively use the functions `getwd()` and `setwd()`.
```{r, echo = FALSE, results = 'asis'}
exercise("Create a new folder on your desktop called RCourse and make this folder the working directory. To ensure you have been successful confirm that the output of `getwd()` refers to your RCourse folder.")
```


## Projects
Instead of setting the working directory each time you restart RStudio you can associate
the contents of a folder with a *project* - then all you have to do is to select the project.

To create a new project use the **New Project** command (available on the **File** menu of the global toolbar).
```{r, echo = FALSE, results = 'asis'}
exercise("Create a new project called RCourse in the RCourse folder on your desktop. As the folder already exists choose the **Create project from: Existing Directory** option.
  To confirm you were successful quit RStudio and double-click the RCourse.Rproj file
  in the RCourse folder - RStudio should restart with RCourse as the working directory.")
```

# Transferring Data

## Comma Separated Files

The simplest way to input and output data is in the form of comma separated files. Comma separated files, which have the suffix **.csv**, are recognised by almost all
statistical and spreadsheet programs including \verb_R_.

The following line of code saves the ToothGrowth data frame in the datasets package to the working directory as 
a csv file called `ToothGrowthMissing`.
```{r, eval = FALSE}
write.csv(datasets::ToothGrowth, "ToothGrowthMissing.csv", row.names = FALSE)
```

```{r, echo = FALSE, results = 'asis'}
exercise("Run the line of code above and then open the ToothGrowthMissing csv file in a spreadsheet program and replace the first five values in the `len` column with `NA`.")
exercise("Now use the `read.csv` function to import the ToothGrowthMissing csv file into the workspace. Use the `na.omit` function to delete the 
missing values. What happens to the data frame when the missing values are deleted?")
```

# Manipulating Data with dplyr

The **dplyr** package provides functions for manipulating data frames. Four key 
functions are:

- filter: chose a subset of rows based on conditions
- select:  chose a subset of columns based on names
- arrange: sort rows
- mutate: add new columns

```{r, echo = FALSE, results = 'asis'}
exercise("What does the following R code do to the ToothGrowth data frame")
```

```{r, eval = FALSE}
install.packages("dplyr")
library(dplyr)

ToothGrowth <- filter(datasets::ToothGrowth, len < 30)
ToothGrowth <- mutate(ToothGrowth, len2 = len * 2)
ToothGrowth <- select(ToothGrowth, len2, supp, dose)
ToothGrowth <- arrange(ToothGrowth, dose, supp, len2)
```

If they were nested the operations would look like the following which is almost unreadable.
```{r, eval = FALSE}
ToothGrowth <- arrange(select(mutate(filter(datasets::ToothGrowth, len < 30), len2 = len * 2), 
  len2, supp, dose), dose, supp, len2)
```

To improve readibility, the same operations can be joined in left to right order using the forward-pipe operator `%>%` in the `magrittr` package
to 
```{r, eval = FALSE}
install.packages("magrittr")
library(magrittr)

ToothGrowth <- datasets::ToothGrowth %>% filter(len < 30) %>% mutate(len2 = len * 2) %>% 
  select(len2, supp, dose) %>% arrange(dose, supp, len2)
```

# Programming

## Scripts
Rather than entering expressions into R one by one at the command line, 
a more efficient method is to type the expressions into a text file 
called a *script* and then send all of them to R at the same time. 
R scripts are indicated by the suffix `.r` or `.R`.

Open a new script using the R Script suboption of the New option in the File menu. Next paste the following expressions into the script.
```{r, eval=FALSE}
# this is a comment!
graphics.off()
rm(ls=objects())

summary(trees)
```

Now save the script in your working directory as `trees.r`. Finally type Command-A to select the entire script then Command-Enter to send it to the console.

Congratulations you've written and executed your first script. The first line is a comment - R ignores it. The second line closes any open graphics windows while the second line removes all objects from the workspace so that the script is starting with a blank slate.

## Coding
For some reason some people still work in farenheit. The following equation
converts a temperature in farenheit ($F$) to celsius ($C$).

$$ C = (F - 32) * 5 / 9$$

```{r, echo = FALSE, results = 'asis'}
exercise("Append code to the `trees.r` script to convert 45 farenheit to celcius.
  Note The correct answer is 7.22.")

exercise("Now use the code to convert the following temperatures in farenheit to celcius:
  0 , 32, 64, 100.")
```
For further information on R coding style see http://stat405.had.co.nz/r-style.html.

## Functions
R's power stems from its extensibility - users can easily write their own functions.
The following code defines a function `farenheit_to_kelvin` which converts a temperature in farenheit to kelvins. The inspiration for this example came from [Software Carpentry's](http://software-carpentry.org/) [novice R bootcamp material](https://github.com/swcarpentry/bc/tree/master/novice/r).
```{r}
farenheit_to_kelvin <- function (farenheit) {
  kelvin <- ((farenheit - 32) * 5 / 9) + 273.15
  return (kelvin)
}
```

The first line tells R that `farenheit_to_kelvin` is a function that takes a single argument named `farenheit`. The squiggly brackets tell R where the function 
definition starts and ends. The first line of code in the function definition
converts `farenheit` to `kelvin` while the second and last line tells the 
function to return the value of `kelvin`.

Paste the code into a script and then run it. R does nothing because executing the code
simply defines the function. Look in your workspace (`ls()`) and you will see
`farenheit_to_kelvin` present. If you type `farenheit_to_kelvin` R will print 
the object for you which in this case is the function definition. 
To call the function you have to follow 
its name with brackets that include any arguments you wish to pass to the function, i.e., `farenheit_to_kelvin(c(0, 32))`.

\begin{Exercise}
Define a function in the \verb_trees.r_ script that calculates the standard deviation of its one argument \verb_y_.
Use the function to calculate the standard deviation of each of the columns in \verb_trees_.

# R Course Cheat Sheet

```{r, echo = FALSE, results = 'asis'}

ktable("Operator" = "Description",
        "`*`" = "Multiplication. *Usage*: `5 * 3`",
        "`/`" = "Division. *Usage*: `x / y`",
        "`+`" = "Addition. *Usage*: `4 + 3`",
        "`-`" = "Subtraction. *Usage*: `x - 5`",
        "`^`" = "Power. *Usage*: `6^3`",
        "`<-`" = "Assignment. *Shortcut*: **alt-**. *Usage*: `x <- 5`",
        "`(`" = "Bracket. *Usage*: `2*(3+5)`",
        "`?`" = "Help file. *Usage*: `?function`",
        "`??`" = "Search help files. *Usage*: `??topic`"
  )

ktable("Math Function" = "Description",
        "`log`" = "Logarithm. *Usage*: `log(x)`",
        "`exp`" = "Exponential. *Usage*: `exp(x)`",
        "`cumsum`" = "Cumulative sum. *Usage*: `cumsum(x)`",
        "`sqrt`" = "Square-root. *Usage*: `sqrt(9)`"
  )

ktable("Vector Function" = "Description",
        "`c`" = "Concatenate. *Usage*: `c(1, 3)`",
        "`seq`" = "Sequence. *Usage*: `seq(1, 4)`",
        "`length`" = "Length. *Usage*: `length(c(1, 2, 3, 4))`"
  )

ktable("Other Function" = "Description",
        "`objects`" = "Objects in workspace. *Usage*: `objects(); objects(2)`. Alias: `ls`",
        "`remove`" = "Remove object(s) from workspace. *Usage*: `remove(list = ls())`"
  )

```
